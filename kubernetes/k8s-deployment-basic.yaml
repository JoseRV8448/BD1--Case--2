# Kubernetes Deployment - PromptSales
# Versión corregida: Sin N8N, con SQL Server

apiVersion: v1
kind: Namespace
metadata:
  name: promptsales

---
# SQL Server (PromptAds + PromptCRM)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sqlserver
  namespace: promptsales
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sqlserver
  template:
    metadata:
      labels:
        app: sqlserver
    spec:
      containers:
      - name: sqlserver
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
        - name: ACCEPT_EULA
          value: "Y"
        - name: SA_PASSWORD
          value: "PromptSales2024!"
        - name: MSSQL_PID
          value: "Developer"
        ports:
        - containerPort: 1433
        volumeMounts:
        - name: mssql-storage
          mountPath: /var/opt/mssql
      volumes:
      - name: mssql-storage
        emptyDir: {}

---
# PostgreSQL (PromptSales DW)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-dw
  namespace: promptsales
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres-dw
  template:
    metadata:
      labels:
        app: postgres-dw
    spec:
      containers:
      - name: postgres
        image: postgres:15
        env:
        - name: POSTGRES_DB
          value: "PromptSales_DW"
        - name: POSTGRES_USER
          value: "admin"
        - name: POSTGRES_PASSWORD
          value: "PromptSales2024!"
        ports:
        - containerPort: 5432
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
      volumes:
      - name: postgres-storage
        emptyDir: {}

---
# MongoDB (PromptContent)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongodb
  namespace: promptsales
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mongodb
  template:
    metadata:
      labels:
        app: mongodb
    spec:
      containers:
      - name: mongodb
        image: mongo:6
        env:
        - name: MONGO_INITDB_DATABASE
          value: "PromptContent"
        - name: MONGO_INITDB_ROOT_USERNAME
          value: "admin"
        - name: MONGO_INITDB_ROOT_PASSWORD
          value: "PromptContent2024!"
        ports:
        - containerPort: 27017
        volumeMounts:
        - name: mongo-storage
          mountPath: /data/db
      volumes:
      - name: mongo-storage
        emptyDir: {}

---
# Redis Cache
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-cache
  namespace: promptsales
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis-cache
  template:
    metadata:
      labels:
        app: redis-cache
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        ports:
        - containerPort: 6379
        volumeMounts:
        - name: redis-storage
          mountPath: /data
      volumes:
      - name: redis-storage
        emptyDir: {}

---
# Services
apiVersion: v1
kind: Service
metadata:
  name: sqlserver
  namespace: promptsales
spec:
  selector:
    app: sqlserver
  ports:
  - port: 1433
    targetPort: 1433
  type: ClusterIP

---
apiVersion: v1
kind: Service
metadata:
  name: postgres-dw
  namespace: promptsales
spec:
  selector:
    app: postgres-dw
  ports:
  - port: 5432
    targetPort: 5432
  type: ClusterIP

---
apiVersion: v1
kind: Service
metadata:
  name: mongodb
  namespace: promptsales
spec:
  selector:
    app: mongodb
  ports:
  - port: 27017
    targetPort: 27017
  type: ClusterIP

---
apiVersion: v1
kind: Service
metadata:
  name: redis-cache
  namespace: promptsales
spec:
  selector:
    app: redis-cache
  ports:
  - port: 6379
    targetPort: 6379
  type: ClusterIP

---
# ConfigMap para scripts de inicialización
apiVersion: v1
kind: ConfigMap
metadata:
  name: db-init-scripts
  namespace: promptsales
data:
  init-sqlserver.sql: |
    -- Crear bases de datos
    CREATE DATABASE PromptAds;
    CREATE DATABASE PromptCRM;
    CREATE DATABASE PromptSales_DW;
    GO
    
    -- Configurar Linked Servers después
    USE PromptCRM;
    EXEC sp_addlinkedserver 
        @server = 'PROMPTADS_LINK',
        @srvproduct = '',
        @provider = 'SQLNCLI',
        @datasrc = 'sqlserver.promptsales.svc.cluster.local';
    GO
    
  init-postgres.sql: |
    -- Crear esquemas para DW
    CREATE SCHEMA staging;
    CREATE SCHEMA dw;
    CREATE SCHEMA etl;